

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Facts Tracker</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        .status {
            margin: 20px 0;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.connected {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #4caf50;
        }
        .status.connecting {
            background: #fff3e0;
            color: #f57f17;
            border: 1px solid #ff9800;
        }
        .status.local {
            background: #fce4ec;
            color: #c2185b;
            border: 1px solid #e91e63;
        }
        input[type="text"], input[type="number"], input[type="password"] {
            padding: 15px;
            font-size: 18px;
            border: 2px solid #ddd;
            border-radius: 8px;
            width: 200px;
            margin: 10px;
            text-align: center;
        }
        button {
            padding: 15px 25px;
            font-size: 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
            font-weight: bold;
        }
        .btn-primary {
            background: #2196f3;
            color: white;
        }
        .btn-success {
            background: #4caf50;
            color: white;
        }
        .btn-secondary {
            background: #757575;
            color: white;
        }
        .btn-warning {
            background: #ff9800;
            color: white;
        }
        button:hover {
            opacity: 0.9;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .problem {
            font-size: 4em;
            margin: 30px 0;
            color: #333;
            font-weight: bold;
        }
        .feedback {
            font-size: 2em;
            margin: 20px 0;
            font-weight: bold;
        }
        .feedback.correct {
            color: #4caf50;
        }
        .feedback.incorrect {
            color: #f44336;
        }
        
        /* Visual Feedback Modal */
        .feedback-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .feedback-content {
            background: white;
            padding: 20px;
            border-radius: 15px;
            max-width: min(90vw, 800px);
            max-height: min(90vh, 600px);
            width: 100%;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow-y: auto;
            box-sizing: border-box;
        }

        /* Mobile adjustments */
        @media (max-width: 768px) {
            .feedback-content {
                padding: 15px;
                max-width: 95vw;
                max-height: 95vh;
            }
            
            .visual-blocks {
                flex-direction: column;
                gap: 15px;
            }
            
            .blocks {
                max-width: none;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .feedback-content {
                padding: 10px;
                border-radius: 10px;
            }
            
            .feedback-title {
                font-size: 1.4em;
            }
            
            .math-step {
                font-size: 1.2em;
            }
            
            .operation-symbol {
                font-size: 1.5em;
                margin: 0 10px;
            }
        }
        
        .feedback-title {
            font-size: 1.8em;
            color: #f44336;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .visual-explanation {
            margin: 30px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
        }
        
        .math-step {
            margin: 15px 0;
            font-size: 1.4em;
            font-weight: bold;
            color: #333;
        }
        
        
        /* Interactive Modal Styles */
        .interaction-section {
            margin: 30px 0;
            padding: 20px;
            background: #fff3e0;
            border-radius: 10px;
            border: 2px solid #ff9800;
        }
        
        .direction-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }
        
        .direction-btn {
            padding: 20px 40px;
            font-size: 1.5em;
            border: 3px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            background: white;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .direction-btn:hover {
            transform: scale(1.05);
            border-color: #2196f3;
        }
        
        .direction-btn.correct {
            background: #4caf50;
            color: white;
            border-color: #2e7d32;
        }
        
        .direction-btn.incorrect {
            background: #f44336;
            color: white;
            border-color: #c62828;
        }
        
        .steps-input {
            margin: 20px 0;
        }
        
        .steps-input input {
            padding: 15px;
            font-size: 1.5em;
            width: 100px;
            text-align: center;
            border: 3px solid #2196f3;
            border-radius: 8px;
            margin: 0 10px;
        }
        
        .steps-input button {
            padding: 15px 30px;
            font-size: 1.2em;
            background: #2196f3;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .feedback-message {
            margin: 15px 0;
            padding: 15px;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: bold;
        }
        
        .feedback-message.correct {
            background: #e8f5e8;
            color: #2e7d32;
            border: 2px solid #4caf50;
        }
        
        .feedback-message.incorrect {
            background: #ffebee;
            color: #c62828;
            border: 2px solid #f44336;
        }
        
        .mini-practice {
            margin: 30px 0;
            padding: 25px;
            background: #e3f2fd;
            border-radius: 10px;
            border: 3px solid #2196f3;
        }
        
        .mini-practice h3 {
            margin-top: 0;
            color: #1976d2;
            font-size: 1.5em;
        }
        
        .mini-problem {
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 8px;
            border: 2px solid #90caf9;
        }
        
        .mini-problem .problem {
            font-size: 2em;
            font-weight: bold;
            margin: 15px 0;
            color: #333;
        }
        
        .mini-problem input {
            padding: 12px;
            font-size: 1.5em;
            width: 120px;
            text-align: center;
            border: 2px solid #ddd;
            border-radius: 6px;
            margin: 10px;
        }
        
        .mini-problem button {
            padding: 12px 25px;
            font-size: 1.1em;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .mini-problem.completed {
            opacity: 0.6;
            border-color: #4caf50;
            background: #e8f5e8;
        }
        
        .progress-indicator {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
        }
        
        .progress-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ddd;
            border: 2px solid #999;
        }
        
        .progress-dot.completed {
            background: #4caf50;
            border-color: #2e7d32;
        }
        
        
        .student-list {
            text-align: left;
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }
        .student-item {
            padding: 10px;
            border: 1px solid #ddd;
            margin: 5px 0;
            border-radius: 5px;
            cursor: pointer;
            background: #f9f9f9;
        }
        .student-item:hover {
            background: #e3f2fd;
        }
        .student-item.selected {
            background: #bbdefb;
            border-color: #2196f3;
        }

      .cache-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .cache-popup {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        .cache-popup h2 {
            color: #333;
            margin-bottom: 20px;
        }
        .cache-popup p {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        .cache-popup button {
            margin: 0 10px;
        }

        
        .grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 20px 0;
        }
        .card {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .card h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .card .number {
            font-size: 2em;
            font-weight: bold;
            color: #2196f3;
        }
        .hidden {
            display: none;
        }
        
        /* Student Detail Sections */
        .student-detail-section {
            margin: 30px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }
        
        .student-detail-section h3 {
            margin: 0 0 15px 0;
            color: #333;
            border-bottom: 2px solid #2196f3;
            padding-bottom: 5px;
        }
        
        .error-patterns {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .pattern-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            text-align: center;
        }
        
        .pattern-problem {
            font-size: 1.2em;
            font-weight: bold;
            color: #f44336;
            margin-bottom: 10px;
        }
        
        .pattern-stats {
            font-size: 0.9em;
            color: #666;
        }
        
        .recent-problems {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .problem-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .problem-table th {
            background: #2196f3;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: bold;
        }
        
        .problem-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
        }
        
        .problem-table tr:hover {
            background: #f5f5f5;
        }
        
        .correct-answer {
            color: #4caf50;
            font-weight: bold;
        }
        
        .incorrect-answer {
            color: #f44336;
            font-weight: bold;
        }
        
        .timestamp {
            font-size: 0.8em;
            color: #666;
        }

        .login-error {
            color: #f44336;
            margin-top: 10px;
            font-weight: bold;
            padding: 10px;
            background: #ffebee;
            border-radius: 5px;
            border: 1px solid #f44336;
        }

        /* Filters Section Styles */
        .filters-section {
            margin: 30px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }

        .filters-section h3 {
            margin: 0 0 20px 0;
            color: #333;
            border-bottom: 2px solid #2196f3;
            padding-bottom: 5px;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .filter-group select {
            width: 100%;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Math Facts Tracker</h1>
        
        <!-- Status Indicator -->
        <div id="status" class="status connecting">
            Connecting to Firebase...
        </div>
        
        <!-- Login Screen -->
        <div id="loginScreen">
            <h2>Student Login</h2>
            <input type="text" id="studentId" placeholder="Enter Student ID" />
            <br>
            <button class="btn-primary" onclick="studentLogin()">Start Practice</button>
            <br><br>
            <button class="btn-success" onclick="showTeacherLogin()">Teacher Dashboard</button>
        </div>
        
        <!-- Teacher Login Screen -->
        <div id="teacherLoginScreen" class="hidden">
            <h2>Teacher Login</h2>
            <p>Enter the teacher password to access the dashboard</p>
            <input type="password" id="teacherPassword" placeholder="Teacher Password" />
            <br>
            <button class="btn-primary" onclick="teacherLogin()">Login</button>
            <br><br>
            <button class="btn-secondary" onclick="backToMainLogin()">Back</button>
            <div id="loginError" class="login-error hidden">
                Incorrect password. Please try again.
            </div>
        </div>
        
        <!-- Student Practice Screen -->
        <div id="practiceScreen" class="hidden">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h2 id="studentWelcome"></h2>
                    <p id="studentScore">Score: 0/0</p>
                </div>
                <button class="btn-secondary" onclick="logout()">Logout</button>
            </div>
            
            <!-- Student Mastery Progress -->
            <div id="studentMasteryProgress" style="margin: 20px 0;">
                <h3 style="text-align: center; color: #333; margin-bottom: 15px;">Your Progress (Need 4 correct in a row to master each type)</h3>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; max-width: 800px; margin: 0 auto;">
                    <!-- Mastery boxes will be populated here -->
                </div>
            </div>
            
            <div id="problemArea">
                <div class="problem" id="problem"></div>
                <input type="number" id="answer" placeholder="?" style="font-size: 2em; width: 150px;" />
                <br>
                <button class="btn-primary" onclick="submitAnswer()">Submit Answer</button>
            </div>
            
            <div id="feedback" class="feedback hidden"></div>
        </div>
        
        <!-- Visual Feedback Modal -->
        <div id="feedbackModal" class="feedback-modal hidden">
            <div class="feedback-content">
                <div class="feedback-title">Let's work through this together!</div>
                <div id="modalContent"></div>
            </div>
        </div>
        
        <!-- Teacher Dashboard -->
        <div id="teacherScreen" class="hidden">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>Teacher Dashboard</h2>
                <div>
                    <button class="btn-secondary" onclick="logout()">Back to Login</button>
                </div>
            </div>
            
            <div class="grid">
                <div class="card">
                    <h3>Total Students</h3>
                    <div class="number" id="totalStudents">0</div>
                </div>
                <div class="card">
                    <h3>Average Mastery</h3>
                    <div class="number" id="averageMastery">0%</div>
                </div>
                <div class="card">
                    <h3>Active Today</h3>
                    <div class="number" id="activeToday">0</div>
                </div>
            </div>
            
            <!-- Class Mastery Overview -->
            <h3>Class Performance Overview</h3>
            <div id="classMasteryOverview" class="grid" style="margin-bottom: 30px;">
                <!-- Class mastery cards will be populated here -->
            </div>
            
            <h3>Add Students</h3>
            
            <!-- Single Student Entry -->
            <div style="margin-bottom: 20px;">
                <h4>Add Single Student</h4>
                <input type="text" id="newStudentId" placeholder="Student ID" />
                <input type="text" id="newStudentName" placeholder="Name" />
                <input type="text" id="newStudentGrade" placeholder="Grade" />
                <input type="text" id="newStudentClass" placeholder="Class" />
                <button class="btn-primary" onclick="addStudent()">Add Student</button>
            </div>
            
            <!-- CSV Upload -->
            <div style="margin-bottom: 20px; padding: 20px; background: #f0f8ff; border-radius: 10px; border: 2px dashed #2196f3;">
                <h4>Upload Students via CSV</h4>
                <p style="margin: 10px 0; color: #666; font-size: 14px;">
                    CSV should have columns: <strong>id, name, grade, class</strong><br>
                    Example: 001,Alice Johnson,3,Math-3A
                </p>
                <input type="file" id="csvFileInput" accept=".csv" style="margin: 10px 0;" />
                <br>
                <button class="btn-success" onclick="uploadCSV()">Upload CSV</button>
                <button class="btn-secondary" onclick="downloadSampleCSV()" style="margin-left: 10px;">Download Sample CSV</button>
            </div>
            
            <div style="margin: 20px 0;">
                <button class="btn-warning" onclick="addSampleStudents()" style="margin-right: 10px;">Add Sample Students</button>
                <button class="btn-secondary" onclick="clearAllStudents()">Clear All Students</button>
            </div>
            
            <!-- Smart Filters Section -->
            <div class="filters-section">
                <h3>Smart Filters</h3>
                <div class="filters-grid">
                    <div class="filter-group">
                        <label for="classFilter">Filter by Class:</label>
                        <select id="classFilter" onchange="applyFilters()">
                            <option value="">All Classes</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="gradeFilter">Filter by Grade:</label>
                        <select id="gradeFilter" onchange="applyFilters()">
                            <option value="">All Grades</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="patternFilter">Filter by Problem Pattern:</label>
                        <select id="patternFilter" onchange="applyFilters()">
                            <option value="">All Patterns</option>
                            <option value="pos_plus_pos">A + B (Positive + Positive)</option>
                            <option value="pos_plus_neg">A + (-B) (Positive + Negative)</option>
                            <option value="pos_minus_pos">A - B (Positive - Positive)</option>
                            <option value="pos_minus_neg">A - (-B) (Positive - Negative)</option>
                            <option value="neg_plus_pos">(-A) + B (Negative + Positive)</option>
                            <option value="neg_plus_neg">(-A) + (-B) (Negative + Negative)</option>
                            <option value="neg_minus_pos">(-A) - B (Negative - Positive)</option>
                            <option value="neg_minus_neg">(-A) - (-B) (Negative - Negative)</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="masteryFilter">Mastery Rate:</label>
                        <select id="masteryFilter" onchange="applyFilters()">
                            <option value="">All Mastery Levels</option>
                            <option value="0-25">0% - 24%</option>
                            <option value="25-50">25% - 49%</option>
                            <option value="50-75">50% - 74%</option>
                            <option value="75-99">75% - 99%</option>
                            <option value="100">100%</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                    <button class="btn-warning" onclick="clearAllFilters()" style="padding: 10px 20px;">Clear All Filters</button>
                    <div id="filterResults" style="font-weight: bold; color: #555;">Showing all students</div>
                </div>
            </div>
            
            <h3>Students</h3>
            <div class="student-list" id="studentList"></div>
            
            <div id="studentProgress" class="hidden">
                <h3 id="progressTitle"></h3>
                <div class="grid">
                    <div class="card">
                        <h3>Mastery %</h3>
                        <div class="number" id="studentMastery">0%</div>
                    </div>
                    <div class="card">
                        <h3>Facts Practiced</h3>
                        <div class="number" id="factsPracticed">0</div>
                    </div>
                    <div class="card">
                        <h3>Total Mistakes</h3>
                        <div class="number" id="totalMistakes">0</div>
                    </div>
                </div>
                
                <!-- Error Patterns Section -->
                <div class="student-detail-section">
                    <h3>Problem Analysis</h3>
                    <div id="errorPatterns" class="error-patterns"></div>
                </div>
                
                <!-- Recent Problems Section -->
                <div class="student-detail-section">
                    <h3>Last 25 Problems</h3>
                    <div id="recentProblems" class="recent-problems"></div>
                </div>
            </div>

<!-- Cache Check Popup -->
            <div id="cachePopup" class="cache-popup-overlay hidden">
                <div class="cache-popup">
                    <h2>üìä No Student Data Found</h2>
                    <p>There is no student data in your cache. Would you like to load the last 50 problems from each student?</p>
                    <button class="btn-success" onclick="loadInitialData()">Yes, Load Data</button>
                    <button class="btn-secondary" onclick="skipInitialLoad()">No, Start Empty</button>
                </div>
            </div>
        </div>


    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
    
// Application State
const TEACHER_PASSWORD = "MathTeacher2024!";
let db = null;
let currentUser = null;
let currentProblem = null;
let score = { correct: 0, total: 0 };
let students = [];
let currentStudentAttempts = []; // Cache for current student's attempts
let teacherMasteryCache = {
    data: null,
    lastFetch: null
};
let teacherDashboardListener = null; // Real-time listener

// Interactive Modal State
let modalState = 'direction'; // direction, steps, solution, practice
let directionAnswer = null;
let stepsAnswer = null;
let miniProblems = [];
let miniProblemResults = [false, false];
        
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDc850NX40XMBTwcypsRy_1zNIm-dMqCzw",
            authDomain: "math-facts-app-v1.firebaseapp.com",
            projectId: "math-facts-app-v1",
            storageBucket: "math-facts-app-v1.firebasestorage.app",
            messagingSenderId: "797235830684",
            appId: "1:797235830684:web:e7c569649fedf456733259",
            measurementId: "G-MYV10DWB5M"
        };

        // Utility Functions
        function updateStatus(type, message) {
            const statusEl = document.getElementById('status');
            statusEl.className = `status ${type}`;
            statusEl.textContent = message;
        }

        function showScreen(screenId) {
            const screens = ['loginScreen', 'teacherLoginScreen', 'practiceScreen', 'teacherScreen'];
            screens.forEach(screen => {
                document.getElementById(screen).classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
        }

        // Firebase Functions
        function initFirebase() {
            console.log('Starting Firebase initialization...');
            try {
                if (typeof firebase !== 'undefined') {
                    firebase.initializeApp(firebaseConfig);
                    db = firebase.firestore();
                    console.log('Firebase initialized successfully');
                    updateStatus('connected', 'Connected to Firebase');
                    loadStudentsFromFirebase();
                } else {
                    console.log('Firebase not available, running in local mode');
                    updateStatus('local', 'Running in local mode');
                    db = null;
                }
            } catch (error) {
                console.error('Firebase initialization failed:', error);
                updateStatus('local', 'Running in local mode');
                db = null;
            }
        }

        async function loadStudentsFromFirebase() {
            if (!db) return;
            
            try {
                console.log('Attempting to load students from Firebase...');
                const snapshot = await db.collection('students').get();
                const firebaseStudents = [];
                
                snapshot.forEach(doc => {
                    console.log('Found student document:', doc.id, doc.data());
                    firebaseStudents.push({ id: doc.id, ...doc.data() });
                });
                
                console.log('Total students loaded from Firebase:', firebaseStudents.length);
                
                if (firebaseStudents.length > 0) {
                    students = firebaseStudents;
                    updateStudentList();
                    populateFilterOptions();
                } else {
                    console.log('No students found in Firebase collection');
                }
            } catch (error) {
                console.error('Error loading students from Firebase:', error);
            }
        }

        // Calculate category-based mastery system
        function calculateCategoryMastery(attempts) {
            const categories = {
                'pos_plus_pos': 'Positive + Positive',
                'pos_plus_neg': 'Positive + Negative', 
                'pos_minus_pos': 'Positive - Positive',
                'pos_minus_neg': 'Positive - Negative',
                'neg_plus_pos': 'Negative + Positive',
                'neg_plus_neg': 'Negative + Negative',
                'neg_minus_pos': 'Negative - Positive',
                'neg_minus_neg': 'Negative - Negative'
            };
            
            const categoryAttempts = {};
            Object.keys(categories).forEach(category => {
                categoryAttempts[category] = [];
            });
            
            attempts.forEach(attempt => {
                const category = categorizeProblem(attempt.problem);
                if (category && categoryAttempts[category]) {
                    categoryAttempts[category].push(attempt);
                }
            });
            
            let masteredCategories = 0;
            const categoryDetails = {};
            
            Object.keys(categories).forEach(categoryKey => {
                const categoryAttemptsList = categoryAttempts[categoryKey];
                
const recentAttempts = categoryAttemptsList
    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
    .slice(0, 4);

const correctCount = recentAttempts.filter(a => a.isCorrect).length;
const totalCount = recentAttempts.length;
const isMastered = totalCount >= 4 && correctCount === 4;
                
                if (isMastered) {
                    masteredCategories++;
                }
                
                categoryDetails[categoryKey] = {
                    name: categories[categoryKey],
                    correct: correctCount,
                    total: totalCount,
                    mastered: isMastered,
                    percentage: totalCount > 0 ? ((correctCount / totalCount) * 100).toFixed(1) : 0
                };
            });
            
            const overallMastery = ((masteredCategories / 8) * 100).toFixed(1);
            
            return {
                percentage: overallMastery,
                masteredCategories,
                totalCategories: 8,
                categoryDetails
            };
        }

        function categorizeProblem(problemString) {
            const parts = problemString.trim().split(/\s+/);
            if (parts.length !== 3) return null;
            
            const num1 = parseInt(parts[0]);
            const operation = parts[1];
            const num2 = parseInt(parts[2]);
            
            if (isNaN(num1) || isNaN(num2)) return null;
            
            const num1Positive = num1 >= 0;
            const num2Positive = num2 >= 0;
            
            if (operation === '+') {
                if (num1Positive && num2Positive) return 'pos_plus_pos';
                if (num1Positive && !num2Positive) return 'pos_plus_neg';
                if (!num1Positive && num2Positive) return 'neg_plus_pos';
                if (!num1Positive && !num2Positive) return 'neg_plus_neg';
            } else if (operation === '-') {
                if (num1Positive && num2Positive) return 'pos_minus_pos';
                if (num1Positive && !num2Positive) return 'pos_minus_neg';
                if (!num1Positive && num2Positive) return 'neg_minus_pos';
                if (!num1Positive && !num2Positive) return 'neg_minus_neg';
            }
            
            return null;
        }

        function displayCategoryMastery(categoryDetails) {
            const categoryOrder = [
                'pos_plus_pos', 'pos_plus_neg', 'pos_minus_pos', 'pos_minus_neg',
                'neg_plus_pos', 'neg_plus_neg', 'neg_minus_pos', 'neg_minus_neg'
            ];
            
            let html = '<div style="display: block; width: 100%;">';
html += '<h4 style="margin-bottom: 15px; color: #333;">Mastery by Problem Type (Need 4/4 of last 4 attempts to master)</h4>';
html += '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px;">';
            
            categoryOrder.forEach(key => {
                const details = categoryDetails[key];
                const bgColor = details.mastered ? '#e8f5e8' : (details.total > 0 ? '#fff3e0' : '#f5f5f5');
                const borderColor = details.mastered ? '#4caf50' : (details.total > 0 ? '#ff9800' : '#ccc');
                const statusIcon = details.mastered ? '‚úÖ' : (details.total > 0 ? '‚è≥' : '‚≠ï');
                
                html += `
                    <div style="background: ${bgColor}; padding: 15px; border-radius: 8px; border: 2px solid ${borderColor}; text-align: center;">
                        <div style="font-weight: bold; color: #333; margin-bottom: 8px; font-size: 0.9em;">${details.name}</div>
                        <div style="font-size: 1.5em; font-weight: bold; margin: 8px 0;">
                            ${statusIcon} ${details.correct}/${details.total}
                        </div>
                            <div style="font-size: 0.9em; color: #666;">
                              ${details.mastered ? 'MASTERED!' : 
                                details.total === 0 ? 'No attempts yet' :
                                `${details.percentage}% correct`}
                              ${details.total < 4 && details.total > 0 ? `<br><small>Need ${4 - details.total} more attempts</small>` : ''}
                              ${details.total === 0 ? `<br><small>Need 4 attempts to check mastery</small>` : ''}
                          </div>  
                    </div>
                `;
              });
            
            html += '</div>';
            html += '</div>'; // Close the wrapper div
            return html;
        }

        // Math Problem Generation
        function generateProblem() {
            const num1 = Math.floor(Math.random() * 21) - 10;
            const num2 = Math.floor(Math.random() * 21) - 10;
            const operation = Math.random() < 0.5 ? '+' : '-';
            const answer = operation === '+' ? num1 + num2 : num1 - num2;
            
            return {
                num1,
                num2,
                operation,
                answer,
                key: `${num1}${operation}${num2}`,
                display: `${num1} ${operation} ${num2} = ?`
            };
        }

        // Student Login Functions
        async function studentLogin() {
    const studentId = document.getElementById('studentId').value.trim();
    const student = students.find(s => s.id === studentId);
    
    if (student) {
        currentUser = student;
        score = { correct: 0, total: 0 };
        
        // Try to load from cache first
        let cachedAttempts = loadStudentAttemptsFromCache(studentId);
        
        if (cachedAttempts && cachedAttempts.length >= 70) {
            // Cache has 70 problems - use cache only, no Firebase read!
            console.log('‚úÖ Using full cache (70 attempts), NO Firebase read needed');
            currentStudentAttempts = cachedAttempts;
        } else if (cachedAttempts && cachedAttempts.length > 0) {
            // Cache exists but has fewer than 70 - fetch only the remaining
            const cacheCount = cachedAttempts.length;
            const neededCount = 70 - cacheCount;
            
            console.log(`üì¶ Cache has ${cacheCount} attempts, fetching ${neededCount} more from Firebase...`);
            
            if (db) {
                try {
                    const snapshot = await db.collection('problemAttempts')
                        .where('studentId', '==', studentId)
                        .orderBy('timestamp', 'desc')
                        .limit(70)
                        .get();
                    
                    const allAttempts = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.timestamp && data.timestamp.toDate) {
                            data.timestamp = data.timestamp.toDate();
                        }
                        allAttempts.push(data);
                    });
                    
                    console.log(`Fetched ${allAttempts.length} total attempts from Firebase`);
                    currentStudentAttempts = allAttempts;
                    
                    // Update cache with fresh data
                    saveStudentAttemptsToCache(studentId, allAttempts);
                } catch (error) {
                    console.error('Error loading student attempts:', error);
                    // Fall back to cached data if Firebase fails
                    currentStudentAttempts = cachedAttempts;
                }
            } else {
                currentStudentAttempts = cachedAttempts;
            }
        } else {
            // No cache - load from Firebase (first time login on this device)
            console.log('üì• No cache found, loading from Firebase...');
            
            if (db) {
                try {
                    const snapshot = await db.collection('problemAttempts')
                        .where('studentId', '==', studentId)
                        .orderBy('timestamp', 'desc')
                        .limit(70)
                        .get();
                    
                    currentStudentAttempts = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.timestamp && data.timestamp.toDate) {
                            data.timestamp = data.timestamp.toDate();
                        }
                        currentStudentAttempts.push(data);
                    });
                    console.log(`Loaded ${currentStudentAttempts.length} attempts from Firebase`);
                    
                    // Save to cache for next time
                    saveStudentAttemptsToCache(studentId, currentStudentAttempts);
                } catch (error) {
                    console.error('Error loading student attempts:', error);
                    currentStudentAttempts = [];
                }
            } else {
                currentStudentAttempts = [];
            }
        }
        
        showScreen('practiceScreen');
        document.getElementById('studentWelcome').textContent = `Welcome, ${student.name}!`;
        updateScore();
        updateStudentMasteryDisplay();
        nextProblem();
    } else {
        if (students.length === 0) {
            alert('No students have been added yet. Please contact your teacher to add you to the system.');
        } else {
            const studentIds = students.map(s => s.id).join(', ');
            alert(`Student ID not found! Available student IDs: ${studentIds}`);
        }
    }
}
        // Student Mastery Display Functions
function updateStudentMasteryDisplay() {
    if (!currentUser) return;
    
    const masteryContainer = document.querySelector('#studentMasteryProgress div[style*="grid"]');
    if (!masteryContainer) return;
    
    // Category definitions
    const categoryTitles = {
        'pos_plus_pos': 'A + B',
        'pos_plus_neg': 'A + (-B)', 
        'pos_minus_pos': 'A - B',
        'pos_minus_neg': 'A - (-B)',
        'neg_plus_pos': '(-A) + B',
        'neg_plus_neg': '(-A) + (-B)',
        'neg_minus_pos': '(-A) - B',
        'neg_minus_neg': '(-A) - (-B)'
    };
    
    const categoryOrder = [
        'pos_plus_pos', 'pos_plus_neg', 'pos_minus_pos', 'pos_minus_neg',
        'neg_plus_pos', 'neg_plus_neg', 'neg_minus_pos', 'neg_minus_neg'
    ];
    
    let categoryDetails = {};
    
    // Initialize with defaults
    categoryOrder.forEach(key => {
        categoryDetails[key] = {
            name: categoryTitles[key],
            correct: 0,
            total: 0,
            mastered: false,
            percentage: 0
        };
    });
    
    // Use LOCAL cache instead of Firebase query
    if (currentStudentAttempts.length > 0) {
        const masteryResults = calculateCategoryMastery(currentStudentAttempts);
        categoryDetails = masteryResults.categoryDetails;
    }
    
    // Generate HTML
    let html = '';
    categoryOrder.forEach(key => {
        const details = categoryDetails[key];
        const bgColor = details.mastered ? '#e8f5e8' : (details.total > 0 ? '#fff3e0' : '#f5f5f5');
        const borderColor = details.mastered ? '#4caf50' : (details.total > 0 ? '#ff9800' : '#ddd');
        const statusIcon = details.mastered ? '‚úÖ' : (details.total > 0 ? '‚è≥' : '‚≠ï');
        
        html += `
            <div style="
                background: ${bgColor}; 
                padding: 8px; 
                border-radius: 6px; 
                border: 2px solid ${borderColor}; 
                text-align: center;
                min-height: 60px;
                display: flex;
                flex-direction: column;
                justify-content: center;
            ">
                <div style="font-weight: bold; color: #333; margin-bottom: 4px; font-size: 0.75em;">
                    ${details.name}
                </div>
                <div style="font-size: 1.1em; font-weight: bold; margin: 2px 0;">
                    ${statusIcon} ${details.correct}/${details.total}
                </div>
                <div style="font-size: 0.65em; color: #666;">
                    ${details.mastered ? 'MASTERED!' : 
                      details.total === 0 ? 'Not tried' :
                      details.total < 4 ? `Need ${4 - details.total} more` :
                      `${details.percentage}%`}
                </div>
            </div>
        `;
    });
    
    masteryContainer.innerHTML = html;
}

        function nextProblem() {
            currentProblem = generateProblem();
            document.getElementById('problem').textContent = currentProblem.display;
            document.getElementById('answer').value = '';
            document.getElementById('answer').focus();
            hideFeedback();
        }

async function submitAnswer() {
    const userAnswer = parseInt(document.getElementById('answer').value);
    if (isNaN(userAnswer)) return;

    const isCorrect = userAnswer === currentProblem.answer;
    score.total++;
    if (isCorrect) score.correct++;
    
    const problemData = {
        studentId: currentUser.id,
        problem: `${currentProblem.num1} ${currentProblem.operation} ${currentProblem.num2}`,
        correctAnswer: currentProblem.answer,
        studentAnswer: userAnswer,
        isCorrect: isCorrect,
        timestamp: new Date(),
        sessionScore: `${score.correct}/${score.total}`
    };
    
    // Add to local cache IMMEDIATELY (no waiting for Firebase)
    currentStudentAttempts.unshift(problemData); // Add to beginning
    if (currentStudentAttempts.length > 70) {
        currentStudentAttempts.pop(); // Keep only last 70
    }
    
    // Save updated cache to localStorage
    saveStudentAttemptsToCache(currentUser.id, currentStudentAttempts);
    
    // Save to Firebase in background (don't wait for it)
    if (db && currentUser) {
        db.collection('problemAttempts').add(problemData)
            .then(docRef => {
                console.log('Problem attempt saved to Firebase with ID:', docRef.id);
            })
            .catch(error => {
                console.error('Error saving problem attempt:', error);
            });
    }
    
    updateScore();
    // Update mastery from LOCAL cache - zero Firebase reads!
    updateStudentMasteryDisplay();
    
    if (isCorrect) {
        showFeedback(true, currentProblem.answer);
        setTimeout(nextProblem, 1000);
    } else {
        showVisualFeedback(currentProblem, userAnswer);
    }
}
            


        function updateScore() {
            document.getElementById('studentScore').textContent = `Score: ${score.correct}/${score.total}`;
        }

        function showFeedback(isCorrect, correctAnswer) {
            const feedbackEl = document.getElementById('feedback');
            feedbackEl.className = `feedback ${isCorrect ? 'correct' : 'incorrect'}`;
            feedbackEl.textContent = isCorrect ? 'Correct!' : `Not quite! The answer is ${correctAnswer}`;
            feedbackEl.classList.remove('hidden');
        }

        function hideFeedback() {
            document.getElementById('feedback').classList.add('hidden');
        }

        // Interactive Visual Feedback Functions
        function showVisualFeedback(problem, userAnswer) {
            modalState = 'direction';
            directionAnswer = null;
            stepsAnswer = null;
            
            document.getElementById('feedbackModal').classList.remove('hidden');
            renderDirectionQuestion();
        }

        function createNumberLineVisual(num1, operation, num2, answer, showArrow = true) {
            const allNumbers = [num1, num2, answer, 0];
            const min = Math.min(...allNumbers) - 2;
            const max = Math.max(...allNumbers) + 2;
            
            let html = '<div style="margin: 30px 0;">';
            
            // Show the original problem
            html += `<div class="math-step" style="margin-bottom: 20px;">
                Problem: ${num1} ${operation} ${num2} = ?
            </div>`;
            
            // Convert subtraction if needed
            const originalOp = operation;
            const originalNum2 = num2;
            let displayNum2 = num2;
            
            if (operation === '-') {
                const opposite = -num2;
                html += `<div class="math-step" style="margin-bottom: 20px; color: #f57c00; font-size: 1.2em;">
                    Remember: Subtracting is the same as adding the opposite!<br>
                    ${num1} - (${num2}) = ${num1} + (${opposite})
                </div>`;
                
                operation = '+';
                displayNum2 = opposite;
            }
            
            // Number line
            html += '<div style="position: relative; margin: 40px 20px; height: 120px;">';
            html += '<svg width="100%" height="120" style="overflow: visible;">';
            
            const range = max - min;
            
            // Main line
            html += `<line x1="0%" y1="60" x2="100%" y2="60" stroke="#333" stroke-width="3"/>`;
            
            // Tick marks and numbers
            for (let i = min; i <= max; i++) {
                const xPos = ((i - min) / range) * 100;
                html += `<line x1="${xPos}%" y1="55" x2="${xPos}%" y2="65" stroke="#333" stroke-width="2"/>`;
                
                const isBold = (i === num1 || i === answer || i === 0);
                html += `<text x="${xPos}%" y="85" text-anchor="middle" 
                    font-size="${isBold ? '16' : '14'}" 
                    font-weight="${isBold ? 'bold' : 'normal'}"
                    fill="${isBold ? '#2196f3' : '#666'}">
                    ${i}
                </text>`;
            }
            
            // Starting point
            const startPos = ((num1 - min) / range) * 100;
            html += `<circle cx="${startPos}%" cy="60" r="6" fill="#4caf50" stroke="#2e7d32" stroke-width="2"/>`;
            html += `<text x="${startPos}%" y="25" text-anchor="middle" font-size="14" font-weight="bold" fill="#2e7d32">
                START
            </text>`;
            
            // Arrow (if showing)
            if (showArrow) {
                const endPos = ((answer - min) / range) * 100;
                const arrowColor = displayNum2 >= 0 ? '#2196f3' : '#f44336';
                
                if (displayNum2 !== 0) {
                    html += `<defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                            <polygon points="0 0, 10 3, 0 6" fill="${arrowColor}" />
                        </marker>
                    </defs>`;
                    
                    html += `<line x1="${startPos}%" y1="35" x2="${endPos}%" y2="35" 
                        stroke="${arrowColor}" stroke-width="4" marker-end="url(#arrowhead)"/>`;
                    
                    const arrowMidPos = (startPos + endPos) / 2;
                    html += `<text x="${arrowMidPos}%" y="20" text-anchor="middle" font-size="14" font-weight="bold" fill="${arrowColor}">
                        ${displayNum2 > 0 ? '+' : ''}${displayNum2}
                    </text>`;
                }
                
                // Ending point
                html += `<circle cx="${endPos}%" cy="60" r="6" fill="#ff9800" stroke="#f57c00" stroke-width="2"/>`;
                html += `<text x="${endPos}%" y="105" text-anchor="middle" font-size="14" font-weight="bold" fill="#f57c00">
                    ANSWER
                </text>`;
                
                // Explanation
                html += '</svg></div>';
                
                html += `<div class="math-step" style="margin-top: 30px; font-size: 1.3em;">
                    Start at <strong style="color: #2e7d32;">${num1}</strong>, 
                    ${displayNum2 >= 0 ? 'move RIGHT' : 'move LEFT'} 
                    <strong style="color: ${arrowColor};">${Math.abs(displayNum2)} ${Math.abs(displayNum2) === 1 ? 'space' : 'spaces'}</strong>, 
                    land on <strong style="color: #f57c00;">${answer}</strong>
                </div>`;
                
                html += `<div class="math-step" style="margin-top: 20px; font-size: 1.5em; color: #4caf50;">
                    ${num1} ${originalOp} (${originalNum2}) = <strong>${answer}</strong>
                </div>`;
            } else {
                html += '</svg></div>';
            }
            
            html += '</div>';
            return html;
        }
        
        function createMiniNumberLine(num1, num2, answer) {
            const allNumbers = [num1, num2, answer, 0];
            const min = Math.min(...allNumbers) - 2;
            const max = Math.max(...allNumbers) + 2;
            
            let html = '<div style="position: relative; margin: 20px 10px; height: 80px;">';
            html += '<svg width="100%" height="80" style="overflow: visible;">';
            
            const range = max - min;
            
            // Main line
            html += `<line x1="0%" y1="40" x2="100%" y2="40" stroke="#333" stroke-width="2"/>`;
            
            // Tick marks and numbers
            for (let i = min; i <= max; i++) {
                const xPos = ((i - min) / range) * 100;
                html += `<line x1="${xPos}%" y1="36" x2="${xPos}%" y2="44" stroke="#333" stroke-width="2"/>`;
                
                const isBold = (i === num1 || i === 0);
                html += `<text x="${xPos}%" y="60" text-anchor="middle" 
                    font-size="${isBold ? '14' : '12'}" 
                    font-weight="${isBold ? 'bold' : 'normal'}"
                    fill="${isBold ? '#2196f3' : '#666'}">
                    ${i}
                </text>`;
            }
            
            // Starting point only
            const startPos = ((num1 - min) / range) * 100;
            html += `<circle cx="${startPos}%" cy="40" r="5" fill="#4caf50" stroke="#2e7d32" stroke-width="2"/>`;
            html += `<text x="${startPos}%" y="20" text-anchor="middle" font-size="12" font-weight="bold" fill="#2e7d32">
                START
            </text>`;
            
            html += '</svg>';
            html += '</div>';
            
            return html;
        }

        function categorizeProblemForMini(num1, operation, num2) {
            const num1Positive = num1 >= 0;
            const num2Positive = num2 >= 0;
            
            if (operation === '+') {
                if (num1Positive && num2Positive) return 'pos_plus_pos';
                if (num1Positive && !num2Positive) return 'pos_plus_neg';
                if (!num1Positive && num2Positive) return 'neg_plus_pos';
                if (!num1Positive && !num2Positive) return 'neg_plus_neg';
            } else {
                if (num1Positive && num2Positive) return 'pos_minus_pos';
                if (num1Positive && !num2Positive) return 'pos_minus_neg';
                if (!num1Positive && num2Positive) return 'neg_minus_pos';
                if (!num1Positive && !num2Positive) return 'neg_minus_neg';
            }
        }
        
        function generateSimilarProblem(category) {
            let num1, num2, operation;
            
            if (category === 'pos_plus_pos') {
                num1 = Math.floor(Math.random() * 10) + 1;
                num2 = Math.floor(Math.random() * 10) + 1;
                operation = '+';
            } else if (category === 'pos_plus_neg') {
                num1 = Math.floor(Math.random() * 10) + 1;
                num2 = -(Math.floor(Math.random() * 10) + 1);
                operation = '+';
            } else if (category === 'pos_minus_pos') {
                num1 = Math.floor(Math.random() * 10) + 1;
                num2 = Math.floor(Math.random() * 10) + 1;
                operation = '-';
            } else if (category === 'pos_minus_neg') {
                num1 = Math.floor(Math.random() * 10) + 1;
                num2 = -(Math.floor(Math.random() * 10) + 1);
                operation = '-';
            } else if (category === 'neg_plus_pos') {
                num1 = -(Math.floor(Math.random() * 10) + 1);
                num2 = Math.floor(Math.random() * 10) + 1;
                operation = '+';
            } else if (category === 'neg_plus_neg') {
                num1 = -(Math.floor(Math.random() * 10) + 1);
                num2 = -(Math.floor(Math.random() * 10) + 1);
                operation = '+';
            } else if (category === 'neg_minus_pos') {
                num1 = -(Math.floor(Math.random() * 10) + 1);
                num2 = Math.floor(Math.random() * 10) + 1;
                operation = '-';
            } else if (category === 'neg_minus_neg') {
                num1 = -(Math.floor(Math.random() * 10) + 1);
                num2 = -(Math.floor(Math.random() * 10) + 1);
                operation = '-';
            }
            
            const answer = operation === '+' ? num1 + num2 : num1 - num2;
            return { num1, num2, operation, answer };
        }
        
        function renderDirectionQuestion() {
            const { num1, operation, num2, answer } = currentProblem;
            
            let html = createNumberLineVisual(num1, operation, num2, answer, false);
            
            html += `<div class="interaction-section">
                <div class="math-step" style="font-size: 1.3em; margin-bottom: 15px;">
                    ü§î Which direction should we move?
                </div>
                <div class="direction-buttons">
                    <button class="direction-btn" onclick="checkDirection('left')">
                        ‚¨ÖÔ∏è LEFT
                    </button>
                    <button class="direction-btn" onclick="checkDirection('right')">
                        ‚û°Ô∏è RIGHT
                    </button>
                </div>
                <div id="directionFeedback"></div>
            </div>`;
            
            document.getElementById('modalContent').innerHTML = html;
        }
        
        function checkDirection(direction) {
            const { num1, operation, num2 } = currentProblem;
            let movementNum = operation === '-' ? -num2 : num2;
            const correctDirection = movementNum >= 0 ? 'right' : 'left';
            
            const isCorrect = direction === correctDirection;
            directionAnswer = isCorrect;
            
            const buttons = document.querySelectorAll('.direction-btn');
            buttons.forEach(btn => {
                btn.disabled = true;
                if (btn.textContent.toLowerCase().includes(direction)) {
                    btn.classList.add(isCorrect ? 'correct' : 'incorrect');
                }
            });
            
            const feedback = document.getElementById('directionFeedback');
            if (isCorrect) {
                feedback.innerHTML = `<div class="feedback-message correct">‚úÖ Correct! We move ${correctDirection.toUpperCase()}!</div>`;
                setTimeout(() => {
                    modalState = 'steps';
                    renderStepsQuestion();
                }, 1500);
            } else {
                feedback.innerHTML = `<div class="feedback-message incorrect">‚ùå Not quite. We actually move ${correctDirection.toUpperCase()}.</div>`;
                setTimeout(() => {
                    modalState = 'steps';
                    renderStepsQuestion();
                }, 2000);
            }
        }
        
        function renderStepsQuestion() {
            const { num1, operation, num2, answer } = currentProblem;
            
            let html = createNumberLineVisual(num1, operation, num2, answer, false);
            
            html += `<div class="interaction-section">
                <div class="math-step" style="font-size: 1.3em; margin-bottom: 15px;">
                    üìè How many spaces do we move?
                </div>
                <div class="steps-input">
                    <input type="number" id="stepsInput" min="0" max="20" placeholder="?">
                    <button onclick="checkSteps()">Submit</button>
                </div>
                <div id="stepsFeedback"></div>
            </div>`;
            
            document.getElementById('modalContent').innerHTML = html;
            setTimeout(() => document.getElementById('stepsInput').focus(), 100);
        }
        
        function checkSteps() {
            const { num1, operation, num2 } = currentProblem;
            let movementNum = operation === '-' ? -num2 : num2;
            const correctSteps = Math.abs(movementNum);
            const userSteps = parseInt(document.getElementById('stepsInput').value);
            
            const isCorrect = userSteps === correctSteps;
            stepsAnswer = isCorrect;
            
            const feedback = document.getElementById('stepsFeedback');
            document.getElementById('stepsInput').disabled = true;
            
            if (isCorrect) {
                feedback.innerHTML = `<div class="feedback-message correct">‚úÖ Perfect! We move ${correctSteps} ${correctSteps === 1 ? 'space' : 'spaces'}!</div>`;
                setTimeout(() => {
                    modalState = 'solution';
                    renderSolution();
                }, 1500);
            } else {
                feedback.innerHTML = `<div class="feedback-message incorrect">‚ùå Not quite. We move ${correctSteps} ${correctSteps === 1 ? 'space' : 'spaces'}.</div>`;
                setTimeout(() => {
                    modalState = 'solution';
                    renderSolution();
                }, 2000);
            }
        }
        
        function renderSolution() {
            const { num1, operation, num2, answer } = currentProblem;
            
            let html = '<div class="visual-explanation">';
            html += '<div class="math-step" style="font-size: 1.5em; color: #2196f3; margin-bottom: 20px;">üìö Here\'s the complete solution:</div>';
            html += createNumberLineVisual(num1, operation, num2, answer, true);
            html += '</div>';
            html += `<button class="btn-success" onclick="startMiniPractice()">Continue to Practice Problems</button>`;
            
            document.getElementById('modalContent').innerHTML = html;
        }
        
        function startMiniPractice() {
            const category = categorizeProblemForMini(currentProblem.num1, currentProblem.operation, currentProblem.num2);
            miniProblems = [
                generateSimilarProblem(category),
                generateSimilarProblem(category)
            ];
            miniProblemResults = [false, false];
            modalState = 'practice';
            renderMiniPractice();
        }
        
        function renderMiniPractice() {
            let html = `<div class="mini-practice">
                <h3>üéØ Now try 2 similar problems!</h3>
                <div class="progress-indicator">
                    <div class="progress-dot ${miniProblemResults[0] ? 'completed' : ''}"></div>
                    <div class="progress-dot ${miniProblemResults[1] ? 'completed' : ''}"></div>
                </div>`;
            
            miniProblems.forEach((problem, index) => {
                const isCompleted = miniProblemResults[index];
                html += `<div class="mini-problem ${isCompleted ? 'completed' : ''}" id="miniProblem${index}">
                    <div><strong>Problem ${index + 1}:</strong></div>
                    <div class="problem">${problem.num1} ${problem.operation} ${problem.num2} = ?</div>`;
                
                html += createMiniNumberLine(problem.num1, problem.num2, problem.answer);
                
                if (!isCompleted) {
                    html += `<input type="number" id="miniAnswer${index}" placeholder="Your answer">
                        <button onclick="checkMiniProblem(${index})">Submit</button>
                        <div id="miniFeedback${index}"></div>`;
                } else {
                    html += `<div class="feedback-message correct">‚úÖ Correct! Answer: ${problem.answer}</div>`;
                }
                
                html += `</div>`;
            });
            
            const allCompleted = miniProblemResults.every(r => r);
            html += `<button class="btn-success" onclick="closeFeedbackModal()" ${!allCompleted ? 'disabled' : ''}>
                ${allCompleted ? 'Done! Return to Practice' : 'Complete both problems to continue'}
            </button>`;
            
            html += '</div>';
            
            document.getElementById('modalContent').innerHTML = html;
        }
        
        function checkMiniProblem(index) {
            const problem = miniProblems[index];
            const userAnswer = parseInt(document.getElementById(`miniAnswer${index}`).value);
            const isCorrect = userAnswer === problem.answer;
            
            const feedback = document.getElementById(`miniFeedback${index}`);
            
            if (isCorrect) {
                miniProblemResults[index] = true;
                feedback.innerHTML = `<div class="feedback-message correct">‚úÖ Correct!</div>`;
                setTimeout(() => {
                    renderMiniPractice();
                }, 1000);
            } else {
                feedback.innerHTML = `<div class="feedback-message incorrect">‚ùå Not quite. Try again!</div>`;
                document.getElementById(`miniAnswer${index}`).value = '';
                document.getElementById(`miniAnswer${index}`).focus();
            }
        }

        function closeFeedbackModal() {
            document.getElementById('feedbackModal').classList.add('hidden');
            nextProblem();
        }

        // Teacher Functions
        function showTeacherLogin() {
            showScreen('teacherLoginScreen');
            document.getElementById('teacherPassword').focus();
            document.getElementById('loginError').classList.add('hidden');
        }

        function teacherLogin() {
            const enteredPassword = document.getElementById('teacherPassword').value;
            
            if (enteredPassword === TEACHER_PASSWORD) {
                document.getElementById('teacherPassword').value = '';
                showTeacherDashboard();
            } else {
                document.getElementById('loginError').classList.remove('hidden');
                document.getElementById('teacherPassword').value = '';
                document.getElementById('teacherPassword').focus();
            }
        }

        function backToMainLogin() {
            document.getElementById('teacherPassword').value = '';
            document.getElementById('loginError').classList.add('hidden');
            showScreen('loginScreen');
        }

async function showTeacherDashboard() {
    showScreen('teacherScreen');
    updateStudentList();
    populateFilterOptions();
    
    // Check cache and prompt if needed
    await checkCacheAndPrompt();
    
    // Set up real-time listener for new problems
    setupTeacherDashboardListener();
}

        async function addStudent() {
            const id = document.getElementById('newStudentId').value.trim();
            const name = document.getElementById('newStudentName').value.trim();
            const grade = document.getElementById('newStudentGrade').value.trim();
            const className = document.getElementById('newStudentClass').value.trim();
            
            if (id && name && grade) {
                if (students.find(s => s.id === id)) {
                    alert('Student ID already exists! Please use a different ID.');
                    return;
                }
                
                const student = { id, name, grade, class: className || 'Unassigned' };
                
                if (db) {
                    try {
                        await db.collection('students').doc(id).set({
                            name: student.name,
                            grade: student.grade,
                            class: student.class
                        });
                        console.log('Student saved to Firebase');
                    } catch (error) {
                        console.error('Error saving to Firebase:', error);
                        alert('Student added locally, but could not save to Firebase. Check your connection.');
                    }
                }
                
                students.push(student);
                
                document.getElementById('newStudentId').value = '';
                document.getElementById('newStudentName').value = '';
                document.getElementById('newStudentGrade').value = '';
                document.getElementById('newStudentClass').value = '';
                
                updateStudentList();
                updateDashboardStats();
                populateFilterOptions();
                
                alert(`Student ${name} (ID: ${id}) added successfully!`);
            } else {
                alert('Please fill in Student ID, Name, and Grade');
            }
        }

        // CSV Upload Functions
// Fixed CSV Upload Function - Replace the existing uploadCSV function with this
async function uploadCSV() {
    const fileInput = document.getElementById('csvFileInput');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('Please select a CSV file first.');
        return;
    }
    
    if (!file.name.toLowerCase().endsWith('.csv')) {
        alert('Please select a valid CSV file.');
        return;
    }
    
    try {
        const text = await file.text();
        const lines = text.split('\n').filter(line => line.trim());
        
        if (lines.length === 0) {
            alert('The CSV file appears to be empty.');
            return;
        }
        
        const newStudents = [];
        const errors = [];
        
        // Parse header to map columns correctly - more robust detection
        const firstLine = lines[0].toLowerCase().trim();
        const headers = firstLine.split(',').map(h => h.trim().replace(/['"]/g, ''));
        
        console.log('CSV Headers detected:', headers);
        
        // Improved column mapping with exact matching first, then fuzzy matching
        const columnMap = {};
        
        headers.forEach((header, index) => {
            const cleanHeader = header.toLowerCase().trim();
            
            // Exact matches first
            if (cleanHeader === 'id') {
                columnMap.id = index;
            } else if (cleanHeader === 'name') {
                columnMap.name = index;
            } else if (cleanHeader === 'grade') {
                columnMap.grade = index;
            } else if (cleanHeader === 'class') {
                columnMap.class = index;
            }
            // Fuzzy matches as fallback
            else if (cleanHeader.includes('id') && !columnMap.id) {
                columnMap.id = index;
            } else if (cleanHeader.includes('name') && !columnMap.name) {
                columnMap.name = index;
            } else if (cleanHeader.includes('grade') && !columnMap.grade) {
                columnMap.grade = index;
            } else if ((cleanHeader.includes('class') || cleanHeader.includes('room')) && !columnMap.class) {
                columnMap.class = index;
            }
        });
        
        console.log('Column mapping detected:', columnMap);
        console.log('Headers array:', headers);
        
        // Verify we found all required columns
        if (columnMap.id === undefined || columnMap.name === undefined || columnMap.grade === undefined) {
            const missingFields = [];
            if (columnMap.id === undefined) missingFields.push('id');
            if (columnMap.name === undefined) missingFields.push('name');
            if (columnMap.grade === undefined) missingFields.push('grade');
            
            alert(`Could not find required columns: ${missingFields.join(', ')}\n\nYour CSV headers: ${headers.join(', ')}\n\nExpected: id, name, grade, class (in any order)`);
            return;
        }
        
        // Process data rows (skip header)
        for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            
            // Better CSV parsing - handle quoted values with commas
            const parts = [];
            let current = '';
            let inQuotes = false;
            
            for (let j = 0; j < line.length; j++) {
                const char = line[j];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    parts.push(current.trim().replace(/^"|"$/g, ''));
                    current = '';
                } else {
                    current += char;
                }
            }
            parts.push(current.trim().replace(/^"|"$/g, '')); // Add final part
            
            console.log(`Line ${i}: ${parts}`); // Debug logging
            
            if (parts.length < Math.max(columnMap.id, columnMap.name, columnMap.grade) + 1) {
                errors.push(`Line ${i + 1}: Not enough columns (found ${parts.length}, need ${Math.max(columnMap.id, columnMap.name, columnMap.grade) + 1})`);
                continue;
            }
            
            const id = parts[columnMap.id]?.toString().trim();
            const name = parts[columnMap.name]?.toString().trim();
            const grade = parts[columnMap.grade]?.toString().trim();
            const className = columnMap.class !== undefined ? parts[columnMap.class]?.toString().trim() : 'Unassigned';
            
            console.log(`Mapped data - ID: "${id}", Name: "${name}", Grade: "${grade}", Class: "${className}"`); // Debug
            
            if (!id || !name || !grade) {
                errors.push(`Line ${i + 1}: Missing required data (id: "${id}", name: "${name}", grade: "${grade}")`);
                continue;
            }
            
            // Check if student ID already exists
            if (students.find(s => s.id === id) || newStudents.find(s => s.id === id)) {
                errors.push(`Line ${i + 1}: Student ID "${id}" already exists`);
                continue;
            }
            
            newStudents.push({
                id: id,
                name: name,
                grade: grade,
                class: className || 'Unassigned'
            });
        }
        
        console.log('Processed students:', newStudents); // Debug
        
        if (errors.length > 0) {
            console.log('Errors found:', errors);
            const proceed = confirm(`Found ${errors.length} error(s):\n\n${errors.slice(0, 5).join('\n')}${errors.length > 5 ? '\n...' : ''}\n\nDo you want to add the ${newStudents.length} valid students?`);
            
            if (!proceed) {
                return;
            }
        }
        
        if (newStudents.length === 0) {
            alert('No valid students found in the CSV file.');
            return;
        }
        
        // Add students to Firebase if connected
        if (db) {
            try {
                const batch = db.batch();
                newStudents.forEach(student => {
                    const docRef = db.collection('students').doc(student.id);
                    batch.set(docRef, {
                        name: student.name,
                        grade: student.grade,
                        class: student.class
                    });
                });
                await batch.commit();
                console.log('Students saved to Firebase via batch');
            } catch (error) {
                console.error('Error saving students to Firebase:', error);
                alert('Students added locally, but could not save to Firebase. Check your connection.');
            }
        }
        
        // Add to local array
        students.push(...newStudents);
        
        // Update UI
        updateStudentList();
        updateDashboardStats();
        populateFilterOptions();
        
        // Clear file input
        fileInput.value = '';
        
        alert(`Successfully added ${newStudents.length} student(s)!${errors.length > 0 ? `\n(${errors.length} lines had errors and were skipped)` : ''}`);
        
    } catch (error) {
        console.error('Error reading CSV file:', error);
        alert('Error reading the CSV file. Please make sure it\'s a valid CSV format.');
    }
}

        function downloadSampleCSV() {
            const csvContent = `id,name,grade,class
001,Alice Johnson,3,Math-3A
002,Bob Smith,3,Math-3A
003,Carol Davis,4,Math-4B
004,David Brown,3,Math-3B
005,Emma Wilson,4,Math-4B`;
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sample_students.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function addSampleStudents() {
            const sampleStudents = [
                { id: '001', name: 'Alice Johnson', grade: '3', class: 'Math-3A' },
                { id: '002', name: 'Bob Smith', grade: '3', class: 'Math-3A' },
                { id: '003', name: 'Carol Davis', grade: '4', class: 'Math-4B' },
                { id: '004', name: 'David Brown', grade: '3', class: 'Math-3B' },
                { id: '005', name: 'Emma Wilson', grade: '4', class: 'Math-4B' }
            ];
            
            if (confirm('Add 5 sample students for testing? This will add test students with IDs 001-005.')) {
                let addedCount = 0;
                
                sampleStudents.forEach(student => {
                    if (!students.find(s => s.id === student.id)) {
                        students.push(student);
                        addedCount++;
                    }
                });
                
                if (addedCount > 0) {
                    updateStudentList();
                    updateDashboardStats();
                    populateFilterOptions();
                    alert(`Added ${addedCount} sample student(s)!`);
                } else {
                    alert('All sample students already exist in the system.');
                }
            }
        }

        async function clearAllStudents() {
            if (confirm('Are you sure you want to delete ALL students? This cannot be undone.')) {
                if (db) {
                    try {
                        console.log('Deleting all students from Firebase...');
                        
                        const snapshot = await db.collection('students').get();
                        
                        if (!snapshot.empty) {
                            const batch = db.batch();
                            snapshot.forEach(doc => {
                                batch.delete(doc.ref);
                            });
                            
                            await batch.commit();
                            console.log('All students deleted from Firebase');
                        }
                        
                        const attemptsSnapshot = await db.collection('problemAttempts').get();
                        if (!attemptsSnapshot.empty) {
                            const attemptsBatch = db.batch();
                            attemptsSnapshot.forEach(doc => {
                                attemptsBatch.delete(doc.ref);
                            });
                            
                            await attemptsBatch.commit();
                            console.log('All problem attempts deleted from Firebase');
                        }
                        
                    } catch (error) {
                        console.error('Error deleting from Firebase:', error);
                        alert('Students deleted locally, but there was an error deleting from Firebase: ' + error.message);
                    }
                }
                
                students = [];
                updateStudentList();
                updateDashboardStats();
                populateFilterOptions();
                document.getElementById('studentProgress').classList.add('hidden');
                alert('All students and their data have been deleted.');
            }
        }

        async function deleteStudent(index) {
            const student = students[index];
            if (confirm(`Are you sure you want to delete ${student.name} (ID: ${student.id})? This will also delete all their problem attempts.`)) {
                if (db) {
                    try {
                        console.log('Deleting student from Firebase:', student.id);
                        
                        await db.collection('students').doc(student.id).delete();
                        console.log('Student document deleted from Firebase');
                        
                        const attemptsSnapshot = await db.collection('problemAttempts')
                            .where('studentId', '==', student.id)
                            .get();
                        
                        if (!attemptsSnapshot.empty) {
                            const batch = db.batch();
                            attemptsSnapshot.forEach(doc => {
                                batch.delete(doc.ref);
                            });
                            
                            await batch.commit();
                            console.log('Student problem attempts deleted from Firebase');
                        }
                        
                    } catch (error) {
                        console.error('Error deleting from Firebase:', error);
                        alert('Student deleted locally, but there was an error deleting from Firebase: ' + error.message);
                    }
                }
                
                students.splice(index, 1);
                updateStudentList();
                updateDashboardStats();
                populateFilterOptions();
                document.getElementById('studentProgress').classList.add('hidden');
            }
        }

        function updateStudentList() {
            const listEl = document.getElementById('studentList');
            listEl.innerHTML = '';
            
            if (students.length === 0) {
                listEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #666; font-style: italic;">No students added yet. Use the form above to add students.</div>';
                return;
            }
            
            // Sort students alphabetically by name
            const sortedStudents = [...students].sort((a, b) => a.name.localeCompare(b.name));

            sortedStudents.forEach((student, index) => {
                const div = document.createElement('div');
                div.className = 'student-item';
                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div onclick="showStudentProgress(students.find(s => s.id === '${student.id}'))" style="flex-grow: 1; cursor: pointer; min-width: 0;">
                            <strong style="display: block; margin-bottom: 2px; word-wrap: break-word; white-space: normal;">${student.name}</strong>
                            <div style="font-size: 0.9em; color: #666;">
                                ID: ${student.id} ‚Ä¢ Grade: ${student.grade} ‚Ä¢ Class: ${student.class}
                            </div>
                        </div>
                        <button onclick="deleteStudent(${students.findIndex(s => s.id === student.id)})" style="background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px; margin-left: 10px; flex-shrink: 0;">Delete</button>
                    </div>
                `;
                listEl.appendChild(div);
            });
        }

async function updateDashboardStats() {
    if (students.length === 0) {
        document.getElementById('totalStudents').textContent = '0';
        document.getElementById('averageMastery').textContent = '0%';
        document.getElementById('activeToday').textContent = '0';
        await updateClassMasteryOverview(null);
        return;
    }
    
    document.getElementById('totalStudents').textContent = students.length;
    
    if (!db) {
        document.getElementById('averageMastery').textContent = 'N/A';
        document.getElementById('activeToday').textContent = 'N/A';
        await updateClassMasteryOverview(null);
        return;
    }
    
    try {
        const masteryData = await getCachedMasteryData();
        
        // Calculate average mastery
        let totalMastery = 0;
        let studentsWithData = 0;
        
        for (const student of students) {
            const studentData = masteryData[student.id];
            if (studentData && studentData.totalAttempts > 0) {
                const allAttempts = [];
                Object.values(studentData.attemptsByCategory).forEach(attempts => {
                    allAttempts.push(...attempts);
                });
                
                if (allAttempts.length > 0) {
                    const masteryResults = calculateCategoryMastery(allAttempts);
                    totalMastery += parseFloat(masteryResults.percentage);
                    studentsWithData++;
                }
            }
        }
        
        const avgMastery = studentsWithData > 0 ? (totalMastery / studentsWithData).toFixed(1) : 0;
        document.getElementById('averageMastery').textContent = avgMastery + '%';
        
        // Calculate active today
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        let activeCount = 0;
        for (const student of students) {
            const studentData = masteryData[student.id];
            if (studentData && studentData.totalAttempts > 0) {
                const allAttempts = [];
                Object.values(studentData.attemptsByCategory).forEach(attempts => {
                    allAttempts.push(...attempts);
                });
                
                const hasActivityToday = allAttempts.some(attempt => {
                    const attemptDate = new Date(attempt.timestamp);
                    attemptDate.setHours(0, 0, 0, 0);
                    return attemptDate.getTime() === today.getTime();
                });
                
                if (hasActivityToday) activeCount++;
            }
        }
        
        document.getElementById('activeToday').textContent = activeCount;
        
        // Update class mastery overview
        await updateClassMasteryOverview(masteryData);
        
    } catch (error) {
        console.error('Error updating dashboard stats:', error);
        document.getElementById('averageMastery').textContent = 'Error';
        document.getElementById('activeToday').textContent = 'Error';
    }
}

        
async function updateClassMasteryOverview(masteryData = null) {
    const container = document.getElementById('classMasteryOverview');
    
    if (students.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #666; font-style: italic;">No students added yet</div>';
        return;
    }
    
    const classes = [...new Set(students.map(s => s.class))].sort();
    
    if (!db || !masteryData) {
        container.innerHTML = classes.map(className => `
            <div class="card" style="min-width: 150px; flex: 1;">
                <h3>${className}</h3>
                <div class="number" style="font-size: 1.5em;">N/A</div>
                <div style="font-size: 0.8em; color: #666;">${students.filter(s => s.class === className).length} students</div>
            </div>
        `).join('');
        return;
    }
    
    const classMasteryData = [];
    
    for (const className of classes) {
        const classStudents = students.filter(s => s.class === className);
        let totalClassMastery = 0;
        let studentsWithData = 0;
        
        for (const student of classStudents) {
            const studentData = masteryData[student.id];
            
            if (studentData && studentData.totalAttempts > 0) {
                const allAttempts = [];
                Object.values(studentData.attemptsByCategory).forEach(categoryAttempts => {
                    allAttempts.push(...categoryAttempts);
                });
                
                if (allAttempts.length > 0) {
                    const masteryResults = calculateCategoryMastery(allAttempts);
                    totalClassMastery += parseFloat(masteryResults.percentage);
                    studentsWithData++;
                }
            }
        }
        
        const averageClassMastery = studentsWithData > 0 ? (totalClassMastery / studentsWithData).toFixed(1) : 0;
        
        classMasteryData.push({
            name: className,
            mastery: averageClassMastery,
            totalStudents: classStudents.length,
            studentsWithData: studentsWithData
        });
    }
    
    container.innerHTML = classMasteryData.map(classData => {
        const masteryColor = classData.mastery >= 80 ? '#4caf50' : 
                           classData.mastery >= 60 ? '#ff9800' : '#f44336';
        
        return `
            <div class="card" style="min-width: 150px; flex: 1;">
                <h3>${classData.name}</h3>
                <div class="number" style="font-size: 1.5em; color: ${masteryColor};">
                    ${classData.studentsWithData > 0 ? classData.mastery + '%' : 'No Data'}
                </div>
                <div style="font-size: 0.8em; color: #666;">
                    ${classData.totalStudents} students
                    ${classData.studentsWithData > 0 ? `<br>${classData.studentsWithData} with data` : ''}
                </div>
            </div>
        `;
    }).join('');
}



        function populateFilterOptions() {
            const classFilter = document.getElementById('classFilter');
            const gradeFilter = document.getElementById('gradeFilter');
            
            if (!classFilter || !gradeFilter) return;
            
            const classes = [...new Set(students.map(s => s.class))].sort();
            const grades = [...new Set(students.map(s => s.grade))].sort();
            
            classFilter.innerHTML = '<option value="">All Classes</option>';
            gradeFilter.innerHTML = '<option value="">All Grades</option>';
            
            classes.forEach(className => {
                const option = document.createElement('option');
                option.value = className;
                option.textContent = className;
                classFilter.appendChild(option);
            });
            
            grades.forEach(grade => {
                const option = document.createElement('option');
                option.value = grade;
                option.textContent = `Grade ${grade}`;
                gradeFilter.appendChild(option);
            });
        }

        // Filter Functions
async function applyFilters() {
    const classFilter = document.getElementById('classFilter').value;
    const gradeFilter = document.getElementById('gradeFilter').value;
    const patternFilter = document.getElementById('patternFilter').value;
    const masteryFilter = document.getElementById('masteryFilter').value;
    
    let filteredStudents = students;
    
    // Apply class/grade filters
    if (classFilter || gradeFilter) {
        filteredStudents = students.filter(student => {
            if (classFilter && student.class !== classFilter) return false;
            if (gradeFilter && student.grade !== gradeFilter) return false;
            return true;
        });
    }
    
    // Apply pattern/mastery filters using cached data - no Firebase read!
    if ((patternFilter || masteryFilter) && db) {
        const masteryData = await getCachedMasteryData();
        filteredStudents = filterByPatternAndMasteryFromCache(filteredStudents, masteryData, patternFilter, masteryFilter);
    }
    
    updateFilteredStudentList(filteredStudents);
    
    const resultsText = `Showing ${filteredStudents.length} of ${students.length} students`;
    document.getElementById('filterResults').textContent = resultsText;
}


function filterByPatternAndMasteryFromCache(studentsToFilter, masteryData, patternFilter, masteryFilter) {
    const filteredStudents = [];
    
    for (const student of studentsToFilter) {
        const studentData = masteryData[student.id];
        
        if (!studentData || studentData.totalAttempts === 0) {
            if (patternFilter || masteryFilter) continue;
        }
        
        let includeStudent = true;
        
        if (patternFilter) {
            const patternAttempts = studentData.attemptsByCategory[patternFilter] || [];
            
            if (patternAttempts.length === 0) {
                includeStudent = false;
            } else if (masteryFilter) {
                // For pattern filter, check if this specific category is mastered
                const recentAttempts = patternAttempts.slice(0, 4); // Already sorted by timestamp desc
                const correctCount = recentAttempts.filter(a => a.isCorrect).length;
                const isMastered = recentAttempts.length >= 4 && correctCount === 4;
                const categoryMastery = isMastered ? 100 : 0; // Category is either mastered (100%) or not (0%)
                
                if (!isInMasteryBucket(categoryMastery, masteryFilter)) {
                    includeStudent = false;
                }
            }
        } else if (masteryFilter) {
            // Calculate overall category-based mastery (same as dashboard)
            const masteredCategories = calculateMasteredCategoriesCount(studentData.attemptsByCategory);
            const overallMastery = (masteredCategories / 8) * 100;
            
            if (!isInMasteryBucket(overallMastery, masteryFilter)) {
                includeStudent = false;
            }
        }
        
        if (includeStudent) {
            filteredStudents.push(student);
        }
    }
    
    return filteredStudents;
}

function calculateMasteredCategoriesCount(attemptsByCategory) {
    let masteredCount = 0;
    
    const categories = ['pos_plus_pos', 'pos_plus_neg', 'pos_minus_pos', 'pos_minus_neg',
                       'neg_plus_pos', 'neg_plus_neg', 'neg_minus_pos', 'neg_minus_neg'];
    
    categories.forEach(category => {
        const attempts = attemptsByCategory[category] || [];
        const recentAttempts = attempts.slice(0, 4); // Already sorted by timestamp desc
        const correctCount = recentAttempts.filter(a => a.isCorrect).length;
        const isMastered = recentAttempts.length >= 4 && correctCount === 4;
        
        if (isMastered) {
            masteredCount++;
        }
    });
    
    return masteredCount;
}

function isInMasteryBucket(masteryRate, bucket) {
    if (!bucket) return true;
    
    if (bucket === '0-25') {
        return masteryRate >= 0 && masteryRate < 25;
    } else if (bucket === '25-50') {
        return masteryRate >= 25 && masteryRate < 50;
    } else if (bucket === '50-75') {
        return masteryRate >= 50 && masteryRate < 75;
    } else if (bucket === '75-99') {
        return masteryRate >= 75 && masteryRate < 100;
    } else if (bucket === '100') {
        return masteryRate === 100;
    }
    
    return true;
}

        

        function updateFilteredStudentList(filteredStudents) {
            const listEl = document.getElementById('studentList');
            listEl.innerHTML = '';
            
            if (filteredStudents.length === 0) {
                listEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #666; font-style: italic;">No students match the current filter criteria.</div>';
                return;
            }
            
            filteredStudents.forEach(student => {
                const div = document.createElement('div');
                div.className = 'student-item';
                div.innerHTML = `
                    <strong>${student.name}</strong><br>
                    ID: ${student.id} ‚Ä¢ Grade: ${student.grade} ‚Ä¢ Class: ${student.class}
                `;
                div.onclick = () => showStudentProgress(student);
                listEl.appendChild(div);
            });
        }

        function clearAllFilters() {
            document.getElementById('classFilter').value = '';
            document.getElementById('gradeFilter').value = '';
            document.getElementById('patternFilter').value = '';
            document.getElementById('masteryFilter').value = '';
            
            updateStudentList();
            document.getElementById('filterResults').textContent = `Showing ${students.length} of ${students.length} students`;
        }

        // Student Progress Functions
            async function showStudentProgress(student) {
                document.getElementById('progressTitle').textContent = `${student.name}'s Progress`;
                document.getElementById('studentProgress').classList.remove('hidden');
                
                document.querySelectorAll('.student-item').forEach(item => {
                    item.classList.remove('selected');
                });
                
                event.target.closest('.student-item').classList.add('selected');
                
                if (db) {
                    await loadStudentProgressFromCache(student.id);
                } else {
                    generateSampleAnalytics(student);
                }
            }

  async function loadStudentProgressFromCache(studentId) {
    try {
        console.log('Loading student progress from cache (zero reads)');
        
        // Get cached mastery data - no Firebase read!
        const masteryData = await getCachedMasteryData();
        const studentData = masteryData[studentId];
        
        if (!studentData || studentData.totalAttempts === 0) {
            document.getElementById('studentMastery').textContent = '0%';
            document.getElementById('factsPracticed').textContent = '0';
            document.getElementById('totalMistakes').textContent = '0';
            document.getElementById('errorPatterns').innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No problem attempts yet. Student needs to practice first!</div>';
            document.getElementById('recentProblems').innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No problems attempted yet.</div>';
            return;
        }
        
        // Collect all cached attempts for this student
        const allAttempts = [];
        Object.values(studentData.attemptsByCategory).forEach(categoryAttempts => {
            allAttempts.push(...categoryAttempts);
        });
        
        // Sort by timestamp descending (newest first)
        allAttempts.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        // Calculate stats
        const totalAttempts = studentData.totalAttempts;
        const correctAttempts = studentData.correctAttempts;
        const incorrectAttempts = totalAttempts - correctAttempts;
        
        // Calculate mastery from cached attempts
        const masteryResults = calculateCategoryMastery(allAttempts);
        
        document.getElementById('studentMastery').textContent = masteryResults.percentage + '%';
        document.getElementById('factsPracticed').textContent = totalAttempts;
        document.getElementById('totalMistakes').textContent = incorrectAttempts;
        
        // Show category mastery
        const html = displayCategoryMastery(masteryResults.categoryDetails);
        document.getElementById('errorPatterns').innerHTML = html;
        
        // Show only last 25 problems from cache
        const last25Problems = allAttempts.slice(0, 25);
        const recentProblemsDiv = document.getElementById('recentProblems');
        
        if (last25Problems.length === 0) {
            recentProblemsDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No recent problems available.</div>';
        } else {
            recentProblemsDiv.innerHTML = `
                <div style="margin-bottom: 10px; padding: 10px; background: #e3f2fd; border-radius: 5px;">
                    <strong>Showing last ${last25Problems.length} problem${last25Problems.length !== 1 ? 's' : ''}</strong>
                    ${totalAttempts > 25 ? ` (${totalAttempts - 25} older problems not shown)` : ''}
                </div>
                <table class="problem-table">
                    <thead>
                        <tr>
                            <th>Problem</th>
                            <th>Student Answer</th>
                            <th>Correct Answer</th>
                            <th>Result</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${last25Problems.map(attempt => `
                            <tr>
                                <td><strong>${attempt.problem} = ?</strong></td>
                                <td class="${attempt.isCorrect ? 'correct-answer' : 'incorrect-answer'}">${attempt.studentAnswer}</td>
                                <td>${attempt.correctAnswer}</td>
                                <td>${attempt.isCorrect ? 'Correct' : 'Wrong'}</td>
                                <td class="timestamp">${new Date(attempt.timestamp).toLocaleString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
    } catch (error) {
        console.error('Error loading student progress from cache:', error);
        
        document.getElementById('studentMastery').textContent = 'Error';
        document.getElementById('factsPracticed').textContent = 'Error';
        document.getElementById('totalMistakes').textContent = 'Error';
        
        document.getElementById('errorPatterns').innerHTML = `
            <div style="text-align: center; padding: 20px; color: #f44336;">
                <strong>Error loading student data:</strong><br>
                ${error.message}
            </div>
        `;
        document.getElementById('recentProblems').innerHTML = `
            <div style="text-align: center; padding: 20px; color: #f44336;">
                Unable to load problem history.
            </div>
        `;
    }
}

        function generateSampleAnalytics(student) {
            document.getElementById('studentMastery').textContent = '67.3%';
            document.getElementById('factsPracticed').textContent = '84';
            document.getElementById('totalMistakes').textContent = '23';
            
            const samplePatterns = [
                { problem: '-3-7', errorRate: '78.6', errors: 11, attempts: 14 },
                { problem: '4--5', errorRate: '71.4', errors: 5, attempts: 7 },
                { problem: '-8+2', errorRate: '60.0', errors: 6, attempts: 10 },
                { problem: '1-9', errorRate: '55.6', errors: 5, attempts: 9 },
                { problem: '-2-6', errorRate: '50.0', errors: 4, attempts: 8 },
                { problem: '3--4', errorRate: '45.5', errors: 5, attempts: 11 }
            ];
            
            const errorPatternsDiv = document.getElementById('errorPatterns');
            errorPatternsDiv.innerHTML = samplePatterns.map(pattern => `
                <div class="pattern-card">
                    <div class="pattern-problem">${pattern.problem.replace(/(\+|\-)/g, ' $1 ')} = ?</div>
                    <div class="pattern-stats">
                        ${pattern.errors} errors out of ${pattern.attempts} attempts<br>
                        <strong>${pattern.errorRate}% error rate</strong>
                    </div>
                </div>
            `).join('');
            
            generateSampleRecentProblems();
        }

        function generateSampleRecentProblems() {
            const sampleProblems = [];
            const operations = ['+', '-'];
            
            for (let i = 0; i < 25; i++) {
                const num1 = Math.floor(Math.random() * 21) - 10;
                const num2 = Math.floor(Math.random() * 21) - 10;
                const operation = operations[Math.floor(Math.random() * operations.length)];
                const correctAnswer = operation === '+' ? num1 + num2 : num1 - num2;
                const isCorrect = Math.random() > 0.25;
                const studentAnswer = isCorrect ? correctAnswer : correctAnswer + Math.floor(Math.random() * 5) - 2;
                
                const timeAgo = Math.floor(Math.random() * 1440);
                const timestamp = new Date(Date.now() - timeAgo * 60000);
                
                sampleProblems.push({
                    problem: `${num1} ${operation} ${num2}`,
                    correctAnswer,
                    studentAnswer,
                    isCorrect,
                    timestamp: timestamp.toLocaleString()
                });
            }
            
            const recentProblemsDiv = document.getElementById('recentProblems');
            recentProblemsDiv.innerHTML = `
                <table class="problem-table">
                    <thead>
                        <tr>
                            <th>Problem</th>
                            <th>Student Answer</th>
                            <th>Correct Answer</th>
                            <th>Result</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sampleProblems.map(p => `
                            <tr>
                                <td><strong>${p.problem} = ?</strong></td>
                                <td class="${p.isCorrect ? 'correct-answer' : 'incorrect-answer'}">${p.studentAnswer}</td>
                                <td>${p.correctAnswer}</td>
                                <td>${p.isCorrect ? 'Correct' : 'Wrong'}</td>
                                <td class="timestamp">${p.timestamp}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // General Functions
function logout() {
    currentUser = null;
    currentProblem = null;
    score = { correct: 0, total: 0 };
    currentStudentAttempts = []; // Clear the cache
    
    // Clean up teacher dashboard listener if exists
    if (teacherDashboardListener) {
        teacherDashboardListener();
        teacherDashboardListener = null;
    }
    
    showScreen('loginScreen');
    document.getElementById('studentProgress').classList.add('hidden');
}

// LocalStorage and Cache Management Functions
function saveTeacherDataToLocalStorage(masteryData) {
    try {
        const dataToSave = {
            masteryData: masteryData,
            timestamp: Date.now(),
            students: students
        };
        localStorage.setItem('teacherDashboardData', JSON.stringify(dataToSave));
        console.log('Teacher data saved to localStorage');
    } catch (error) {
        console.error('Error saving to localStorage:', error);
    }
}

function loadTeacherDataFromLocalStorage() {
    try {
        const savedData = localStorage.getItem('teacherDashboardData');
        if (savedData) {
            const parsed = JSON.parse(savedData);
            console.log('Loaded teacher data from localStorage, age:', Date.now() - parsed.timestamp, 'ms');
            return parsed;
        }
    } catch (error) {
        console.error('Error loading from localStorage:', error);
    }
    return null;
}

// Student-specific cache functions
function saveStudentAttemptsToCache(studentId, attempts) {
    try {
        const cacheKey = `studentAttempts_${studentId}`;
        const dataToSave = {
            studentId: studentId,
            attempts: attempts.slice(0, 70), // Keep only last 70
            timestamp: Date.now()
        };
        localStorage.setItem(cacheKey, JSON.stringify(dataToSave));
        console.log(`Saved ${attempts.length} attempts to cache for student ${studentId}`);
    } catch (error) {
        console.error('Error saving student attempts to cache:', error);
    }
}

function loadStudentAttemptsFromCache(studentId) {
    try {
        const cacheKey = `studentAttempts_${studentId}`;
        const savedData = localStorage.getItem(cacheKey);
        if (savedData) {
            const parsed = JSON.parse(savedData);
            // Verify the cache is for the correct student
            if (parsed.studentId === studentId && parsed.attempts) {
                console.log(`Loaded ${parsed.attempts.length} attempts from cache for student ${studentId}`);
                return parsed.attempts;
            }
        }
    } catch (error) {
        console.error('Error loading student attempts from cache:', error);
    }
    return null;
}

async function loadMasteryDataForAllStudents() {
    if (!db) return {};
    
    console.log('Loading ALL problem attempts in a single query...');
    
    try {
        const snapshot = await db.collection('problemAttempts')
            .orderBy('timestamp', 'desc')
            .limit(50 * students.length)
            .get();
        
        console.log(`Loaded ${snapshot.size} total attempts in single query`);
        
        const masteryData = {};
        
        students.forEach(student => {
            masteryData[student.id] = {
                attemptsByCategory: {
                    'pos_plus_pos': [], 'pos_plus_neg': [], 'pos_minus_pos': [], 'pos_minus_neg': [],
                    'neg_plus_pos': [], 'neg_plus_neg': [], 'neg_minus_pos': [], 'neg_minus_neg': []
                },
                totalAttempts: 0,
                correctAttempts: 0,
                allAttempts: []
            };
        });
        
        snapshot.forEach(doc => {
            const data = doc.data();
            if (data.timestamp?.toDate) data.timestamp = data.timestamp.toDate();
            
            const studentId = data.studentId;
            if (!masteryData[studentId]) return;
            
            const studentData = masteryData[studentId];
            studentData.allAttempts.push(data);
            studentData.totalAttempts++;
            if (data.isCorrect) studentData.correctAttempts++;
            
            const category = categorizeProblem(data.problem);
            if (category && studentData.attemptsByCategory[category]) {
                if (studentData.attemptsByCategory[category].length < 4) {
                    studentData.attemptsByCategory[category].push(data);
                }
            }
        });
        
        return masteryData;
    } catch (error) {
        console.error('Error loading mastery data:', error);
        return {};
    }
}

async function getCachedMasteryData() {
    // Check localStorage first
    const savedData = loadTeacherDataFromLocalStorage();
    if (savedData && savedData.masteryData) {
        console.log('Using cached data from localStorage');
        teacherMasteryCache.data = savedData.masteryData;
        teacherMasteryCache.lastFetch = savedData.timestamp;
        return savedData.masteryData;
    }
    
    // No cache exists - return empty data structure
    console.log('No cache found - returning empty data');
    const emptyData = {};
    students.forEach(student => {
        emptyData[student.id] = {
            attemptsByCategory: {
                'pos_plus_pos': [], 'pos_plus_neg': [], 'pos_minus_pos': [], 'pos_minus_neg': [],
                'neg_plus_pos': [], 'neg_plus_neg': [], 'neg_minus_pos': [], 'neg_minus_neg': []
            },
            totalAttempts: 0,
            correctAttempts: 0,
            allAttempts: []
        };
    });
    return emptyData;
}

        async function loadInitialData() {
    document.getElementById('cachePopup').classList.add('hidden');
    
    console.log('Loading initial student data...');
    const data = await loadMasteryDataForAllStudents();
    teacherMasteryCache.data = data;
    teacherMasteryCache.lastFetch = Date.now();
    
    saveTeacherDataToLocalStorage(data);
    await updateDashboardStats();
}

function skipInitialLoad() {
    document.getElementById('cachePopup').classList.add('hidden');
    console.log('Starting with empty dashboard');
    // Dashboard will show with 0 data until students submit new problems
}

async function checkCacheAndPrompt() {
    const savedData = loadTeacherDataFromLocalStorage();
    
    if (!savedData || !savedData.masteryData) {
        // No cache - show popup
        document.getElementById('cachePopup').classList.remove('hidden');
    } else {
        // Cache exists - use it
        await updateDashboardStats();
    }
}

function setupTeacherDashboardListener() {
    if (!db || teacherDashboardListener) return;
    
    console.log('Setting up real-time listener for new problem attempts...');
    
    teacherDashboardListener = db.collection('problemAttempts')
        .where('timestamp', '>', new Date())
        .onSnapshot(snapshot => {
            if (snapshot.empty) return;
            
            console.log('Received', snapshot.size, 'new problem attempts');
            
            snapshot.docChanges().forEach(change => {
                if (change.type === 'added') {
                    const data = change.doc.data();
                    if (data.timestamp?.toDate) data.timestamp = data.timestamp.toDate();
                    
                    const studentId = data.studentId;
                    
                    // Update in-memory cache
                    if (teacherMasteryCache.data && teacherMasteryCache.data[studentId]) {
                        const category = categorizeProblem(data.problem);
                        
                        // Add to category if we have room (keep last 4)
                        if (category && teacherMasteryCache.data[studentId].attemptsByCategory[category]) {
                            const categoryAttempts = teacherMasteryCache.data[studentId].attemptsByCategory[category];
                            categoryAttempts.unshift(data);
                            if (categoryAttempts.length > 4) {
                                categoryAttempts.pop();
                            }
                        }
                        
                        // Update totals
                        teacherMasteryCache.data[studentId].totalAttempts++;
                        if (data.isCorrect) {
                            teacherMasteryCache.data[studentId].correctAttempts++;
                        }
                    }
                }
            });
            
            // Save updated cache to localStorage
            saveTeacherDataToLocalStorage(teacherMasteryCache.data);
            
            // Refresh dashboard display if we're on teacher screen
            if (!document.getElementById('teacherScreen').classList.contains('hidden')) {
                updateDashboardStats();
            }
        });
}


      
        // Event Listeners
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (modalState === 'steps' && document.getElementById('stepsInput')) {
                    checkSteps();
                } else if (!document.getElementById('practiceScreen').classList.contains('hidden')) {
                    submitAnswer();
                } else if (!document.getElementById('loginScreen').classList.contains('hidden')) {
                    studentLogin();
                } else if (!document.getElementById('teacherLoginScreen').classList.contains('hidden')) {
                    teacherLogin();
                }
            }
        });

        // Initialize application when page loads
        window.addEventListener('load', function() {
            console.log('Page loaded, initializing application...');
            initFirebase();
        });
    </script>
</body>
</html>
